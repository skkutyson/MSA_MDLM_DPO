# MSAGPT

<table>
  <tr>
    <td>
      <h2>MSAGPT</h2>
      <p>ðŸ“– Paper: <a href="https://arxiv.org/abs/2406.05347">MSAGPT: Neural Prompting Protein Structure Prediction via MSA Generative Pre-Training</a></p>
      <p><b>MSAGPT</b> is a powerful protein language model (PLM). MSAGPT has 3 billion parameters with three versions of the model, MSAGPT, MSAGPT-Sft, and MSAGPT-Dpo, <b>supporting zero-shot and few-shot MSA generation</b>.</p>
      <p><b>MSAGPT achieves state-of-the-art structural prediction performance on natural MSA-scarce scenarios</b>.</p>
    </td>
  </tr>
</table>


## Overall Framework
<p align="center">
<img src="resources/overall_frame.png" alt="æè¿°æ–‡å­—" style="display: block; margin: auto; width: 90%;">
</p>

## Visualized Cases
Visualization of improved structure prediction compared with nature MSA.
<font color=orange>Yellow</font>: Ground truth; 
<font color=purple>Purple</font>: Predictions based on MSA generated by MSAGPT; 
<font color=cyan>Cyan</font>: Predictions from MSA generated by natural MSA.

<p align="center">
<img src="resources/app_case.png" alt="æè¿°æ–‡å­—" style="display: block; margin: auto; width: 90%;">
</p>


## Get Started: 

### Option 1ï¼šDeploy MSAGPT by yourself

We support GUI for model inference.

First, we need to install the dependencies.

```bash
# CUDA >= 11.8
pip install -r requirements.txt
```

#### Model List
You can choose to manually download the necessary weights. Then UNZIP it and put it into the **checkpoints** folder.

| Model            | Type | Seq Length | Download                                                                                                                                |                                                                                                                                                                                
|------------------|------|------------|-----------------------------------------------------------------------------------------------------------------------------------------|
| MSAGPT         | Base | 16K         | [ðŸ¤— Huggingface](https://huggingface.co/THUDM/MSAGPT)  [ðŸ”¨ SwissArmyTransformer](https://cloud.tsinghua.edu.cn/f/ebfc954a4cd24cef9243/?dl=1)  |
| MSAGPT-SFT   | Sft | 16K        | [ðŸ¤— Huggingface](https://huggingface.co/THUDM/MSAGPT)  [ðŸ”¨ SwissArmyTransformer](https://cloud.tsinghua.edu.cn/f/32da3eadf6e042aab2fa/?dl=1)   |
| MSAGPT-DPO | Rlhf | 16K         | [ðŸ¤— Huggingface](https://huggingface.co/THUDM/MSAGPT)  [ðŸ”¨ SwissArmyTransformer](https://cloud.tsinghua.edu.cn/f/ebfc954a4cd24cef9243/?dl=1) |                                                                                                                                                                                      |                                                                                                                                                                                  |


#### Situation 1.1 CLI (SAT version)

Run CLI demo via:

```bash
# Online Chat
bash scripts/cli_sat.sh --from_pretrained ./checkpoints/MSAGPT-DPO --input-source chat --stream_chat --max-gen-length 1024
```

The program will automatically interact in the command line. You can generate replies entering the protein sequence you need to generate virtual MSAs (or add a few MSAs as a prompt, connected by "\<M\>"), for example: "PEGKQGDPGIPGEPGPPGPPGPQGARGPPG\<M\>VTVEFVNSCLIGDMGVDGPPGQQGQPGPPG", where "PEGKQGDPGIPGEPGPPGPPGPQGARGPPG" is the main sequence, and "VTVEFVNSCLIGDMGVDGPPGQQGQPGPPG" are MSA prompts, and pressing enter. Enter `stop` to stop the program. The chat CLI looks like:
<p align="center">
<img src="resources/demo.gif" alt="æè¿°æ–‡å­—" style="display: block; margin: auto; width: 90%;">
</p>


You can also enable the offline generation by set the **--input-source \<your input file\>** and **--output-path \<your output path\>**.
We set an input file example: *msa_input*. 
```bash
# Offline Generation
bash scripts/cli_sat.sh --from_pretrained ./checkpoints/MSAGPT-DPO --input-source <your input file> --output-path <your output path> --max-gen-length 1024
```

#### Situation 1.2 CLI (Huggingface version)
(TODO)

#### Situation 1.3 Web Demo
(TODO)

### Option 2: Training MDLM (Masked Diffusion Language Model)

This repository includes training infrastructure for MDLM with DPO (Direct Preference Optimization) for protein MSA generation.

#### 2.1 Data Preparation

Download and process OpenProteinSet data:

```bash
# Download MSA files (requires AWS CLI: pip install awscli)
python scripts/prepare_dataset.py download --output ./data/openproteinset --max-files 1000

# Process and filter MSAs
python scripts/prepare_dataset.py process \
    --input ./data/openproteinset \
    --output ./data/processed

# Generate preference pairs for DPO (after pre-training)
python scripts/prepare_dataset.py generate-preferences \
    --model-path ./checkpoints/mdlm_pretrain/last.ckpt \
    --input ./data/processed/msas.jsonl \
    --output ./data/preference_pairs.jsonl
```

#### 2.2 Pre-training

Train the MDLM model on MSA data:

```bash
python scripts/train_mdlm.py --config configs/train_mdlm.yaml \
    --data.path ./data/openproteinset \
    --training.max_steps 100000
```

Key hyperparameters (from MSAGPT paper):
- Batch size: 48 MSAs, 12,288 residues per batch
- Learning rate: 1.2e-4 with cosine schedule
- Optimizer: AdamW (beta1=0.9, beta2=0.95)

#### 2.3 DPO Fine-tuning

Fine-tune with Direct Preference Optimization:

```bash
python scripts/train_mdlm_dpo.py --config configs/train_dpo.yaml \
    --model.checkpoint_path ./checkpoints/mdlm_pretrain/last.ckpt \
    --data.path ./data/preference_pairs.jsonl
```

DPO hyperparameters:
- Learning rate: 1e-6
- Beta (DPO temperature): 0.1
- Lambda (CE regularization): 0.1

#### 2.4 Training Infrastructure

```
training/
â”œâ”€â”€ datasets/
â”‚   â”œâ”€â”€ openproteinset_loader.py    # OpenProteinSet A3M/FASTA parser
â”‚   â”œâ”€â”€ msa_dataset.py              # Pre-training dataset with 2D positions
â”‚   â”œâ”€â”€ msa_preference_dataset.py   # DPO preference pairs dataset
â”‚   â””â”€â”€ preference_generator.py     # Generate pairs using proxy metrics
â”œâ”€â”€ losses/
â”‚   â”œâ”€â”€ mdlm_loss.py                # Diffusion NLL loss (SUBS parameterization)
â”‚   â””â”€â”€ mdlm_dpo_loss.py            # D3PO loss for masked diffusion
â”œâ”€â”€ trainers/
â”‚   â”œâ”€â”€ mdlm_trainer.py             # PyTorch Lightning pre-training module
â”‚   â””â”€â”€ mdlm_dpo_trainer.py         # DPO fine-tuning module
â””â”€â”€ utils/
    â”œâ”€â”€ ema.py                      # Exponential Moving Average
    â””â”€â”€ metrics.py                  # Perplexity, accuracy metrics
```

### Hardware requirement

* Model Inference:
  For BF16: 1 * A100(80G) 

* Finetuning:

  For BF16: 4 * A100(80G) *[Recommend]*.


## Natural MSA-scarce benchmark
Please find the 199 cases along with their retrieved MSAs in the [natural-msa-scarce-cases.txt](./natural-msa-scarce-cases.txt) file. Each line is structured as follows:
```
<PDB-id> <Primary Sequence> <M> <MSA1> <M> ... <MSAn>
```

### Explanation of the Data Structure
- **`<PDB-id>`**: The unique identifier for the protein structure.
- **`<Primary Sequence>`**: The amino acid sequence of the protein.
- **`<M>`**: A delimiter separating different sections.
- **`<MSA1> ... <MSAn>`**: The multiple sequence alignments retrieved for each case.



## License

The code in this repository is open source under the [Apache-2.0 license](./LICENSE).

If you find our work helpful, please consider citing the our paper

```
@article{chen2024msagpt,
  title={MSAGPT: Neural Prompting Protein Structure Prediction via MSA Generative Pre-Training},
  author={Chen, Bo and Bei, Zhilei and Cheng, Xingyi and Li, Pan and Tang, Jie and Song, Le},
  journal={arXiv preprint arXiv:2406.05347},
  year={2024}
}
```